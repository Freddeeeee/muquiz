@model PlayerGameVM

<h1>Welcome to game @Model.GameId, @Model.Name!</h1>

<div id="content">

</div>

@section scripts {
    <script src="https://cdn.jsdelivr.net/npm/@@aspnet/signalr@1.1.0/dist/browser/signalr.min.js"></script>
    <script type="text/javascript">
        (async function () {
            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/gamehub")
                .build();

            async function getPartialView(url) {
                await $.ajax({
                    url: url,
                    type: "GET",
                    success: function (result) {
                        $("#content").html(result);
                    },
                    error: function (result) {
                        console.log(result);
                    }
                });
            }

            async function getPlayerWaitingScreen() {
                await getPartialView("/player/showwaitingscreen");
            }

            async function getPlayerAlternatives(songId) {
                await getPartialView("/player/showalternatives?song=" + songId);
            }

            async function getPlayerFinalPosition(position) {
                await getPartialView("/player/showfinalposition?position=" + position);
            }

            async function submitAnswer() {
                await connection.invoke("SendAnswer", "svar");
                getPlayerWaitingScreen();
            };

            window.submitAnswer = submitAnswer;

            await connection.start().catch(err => console.log(err));

            connection.invoke("AddToGroup", "@Model.GameId");

            connection.on("receivedsong", async function (song) {
                // to-do: request answers and build url
                let songId = "test";
                await getPlayerAlternatives(songId);
            });

            connection.on("getwaitingscreen", async function () {
                await getPlayerWaitingScreen();
            });

            connection.on("getfinalposition", async function (position) {
                // to-do: send userId instead?
                await getPlayerFinalPosition(position);
            })
        })();
    </script>
}